import r from"fs";import e from"axios";import t from"socks-proxy-agent";import n from"https-proxy-agent";import o from"async-retry";function i(){return i=Object.assign?Object.assign.bind():function(r){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(r[n]=t[n])}return r},i.apply(this,arguments)}function s(r,e){try{var t=r()}catch(r){return e(r)}return t&&t.then?t.then(void 0,e):t}var a=new RegExp(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&/=]*)/gi),u="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",c={retries:10,factor:1},f=function(r){function e(r,e,n,o,i,s,a){return t(e&n|~e&o,r,e,i,s,a)}function t(r,e,t,n,o,i){var a,u;return s((a=s(s(e,r),s(n,i)))<<(u=o)|a>>>32-u,t)}function n(r,e,n,o,i,s,a){return t(n^(e|~o),r,e,i,s,a)}function o(r,e,n,o,i,s,a){return t(e^n^o,r,e,i,s,a)}function i(r,e,n,o,i,s,a){return t(e&o|n&~o,r,e,i,s,a)}function s(r,e){var t=(65535&r)+(65535&e);return(r>>16)+(e>>16)+(t>>16)<<16|65535&t}return function(r){var e,t,n="0123456789abcdef",o="";for(t=0;t<r.length;t+=1)e=r.charCodeAt(t),o+=n.charAt(e>>>4&15)+n.charAt(15&e);return o}((a="https://h5.tu.qq.com"+function(r){void 0===r&&(r="");var e=encodeURIComponent(r).match(/%[89ABab]/g);return r.length+(e?e.length:0)}(JSON.stringify(r))+"HQ31X02e",function(r){return function(r){var e,t="",n=32*r.length;for(e=0;e<n;e+=8)t+=String.fromCharCode(r[e>>5]>>>e%32&255);return t}(function(r,t){var a,u,c,f,h;r[t>>5]|=128<<t%32,r[14+(t+64>>>9<<4)]=t;var l=1732584193,m=-271733879,p=-1732584194,v=271733878;for(a=0;a<r.length;a+=16)u=l,c=m,f=p,h=v,l=e(l,m,p,v,r[a],7,-680876936),v=e(v,l,m,p,r[a+1],12,-389564586),p=e(p,v,l,m,r[a+2],17,606105819),m=e(m,p,v,l,r[a+3],22,-1044525330),l=e(l,m,p,v,r[a+4],7,-176418897),v=e(v,l,m,p,r[a+5],12,1200080426),p=e(p,v,l,m,r[a+6],17,-1473231341),m=e(m,p,v,l,r[a+7],22,-45705983),l=e(l,m,p,v,r[a+8],7,1770035416),v=e(v,l,m,p,r[a+9],12,-1958414417),p=e(p,v,l,m,r[a+10],17,-42063),m=e(m,p,v,l,r[a+11],22,-1990404162),l=e(l,m,p,v,r[a+12],7,1804603682),v=e(v,l,m,p,r[a+13],12,-40341101),p=e(p,v,l,m,r[a+14],17,-1502002290),l=i(l,m=e(m,p,v,l,r[a+15],22,1236535329),p,v,r[a+1],5,-165796510),v=i(v,l,m,p,r[a+6],9,-1069501632),p=i(p,v,l,m,r[a+11],14,643717713),m=i(m,p,v,l,r[a],20,-373897302),l=i(l,m,p,v,r[a+5],5,-701558691),v=i(v,l,m,p,r[a+10],9,38016083),p=i(p,v,l,m,r[a+15],14,-660478335),m=i(m,p,v,l,r[a+4],20,-405537848),l=i(l,m,p,v,r[a+9],5,568446438),v=i(v,l,m,p,r[a+14],9,-1019803690),p=i(p,v,l,m,r[a+3],14,-187363961),m=i(m,p,v,l,r[a+8],20,1163531501),l=i(l,m,p,v,r[a+13],5,-1444681467),v=i(v,l,m,p,r[a+2],9,-51403784),p=i(p,v,l,m,r[a+7],14,1735328473),l=o(l,m=i(m,p,v,l,r[a+12],20,-1926607734),p,v,r[a+5],4,-378558),v=o(v,l,m,p,r[a+8],11,-2022574463),p=o(p,v,l,m,r[a+11],16,1839030562),m=o(m,p,v,l,r[a+14],23,-35309556),l=o(l,m,p,v,r[a+1],4,-1530992060),v=o(v,l,m,p,r[a+4],11,1272893353),p=o(p,v,l,m,r[a+7],16,-155497632),m=o(m,p,v,l,r[a+10],23,-1094730640),l=o(l,m,p,v,r[a+13],4,681279174),v=o(v,l,m,p,r[a],11,-358537222),p=o(p,v,l,m,r[a+3],16,-722521979),m=o(m,p,v,l,r[a+6],23,76029189),l=o(l,m,p,v,r[a+9],4,-640364487),v=o(v,l,m,p,r[a+12],11,-421815835),p=o(p,v,l,m,r[a+15],16,530742520),l=n(l,m=o(m,p,v,l,r[a+2],23,-995338651),p,v,r[a],6,-198630844),v=n(v,l,m,p,r[a+7],10,1126891415),p=n(p,v,l,m,r[a+14],15,-1416354905),m=n(m,p,v,l,r[a+5],21,-57434055),l=n(l,m,p,v,r[a+12],6,1700485571),v=n(v,l,m,p,r[a+3],10,-1894986606),p=n(p,v,l,m,r[a+10],15,-1051523),m=n(m,p,v,l,r[a+1],21,-2054922799),l=n(l,m,p,v,r[a+8],6,1873313359),v=n(v,l,m,p,r[a+15],10,-30611744),p=n(p,v,l,m,r[a+6],15,-1560198380),m=n(m,p,v,l,r[a+13],21,1309151649),l=n(l,m,p,v,r[a+4],6,-145523070),v=n(v,l,m,p,r[a+11],10,-1120210379),p=n(p,v,l,m,r[a+2],15,718787259),m=n(m,p,v,l,r[a+9],21,-343485551),l=s(l,u),m=s(m,c),p=s(p,f),v=s(v,h);return[l,m,p,v]}(function(r){var e,t=[];for(t[(r.length>>2)-1]=void 0,e=0;e<t.length;e+=1)t[e]=0;var n=8*r.length;for(e=0;e<n;e+=8)t[e>>5]|=(255&r.charCodeAt(e/8))<<e%32;return t}(r),8*r.length))}(function(r){return decodeURIComponent(encodeURIComponent(r))}(a))));var a},h=function(t,n,c){try{var f,h=function(){if("string"==typeof t)return function(){if(t.match(a))return s(function(){return Promise.resolve(o(function(){try{return Promise.resolve(e.request({method:"GET",url:t,headers:{"User-Agent":u},responseType:"arraybuffer",httpsAgent:n,proxy:!1})).then(function(r){return r.data})}catch(r){return Promise.reject(r)}},i({},c))).then(function(r){f=r})},function(r){throw new Error("Unable to download media: "+r.toString())});var h=s(function(){return Promise.resolve(r.promises.access(t,r.promises.constants.F_OK)).then(function(){return Promise.resolve(r.promises.readFile(t)).then(function(r){f=r})})},function(){f=Buffer.from(t,"base64")});return h&&h.then?h.then(function(){}):void 0}();f=t}();return Promise.resolve(h&&h.then?h.then(function(r){return f}):f)}catch(r){return Promise.reject(r)}},l=function(r,e){return Promise.resolve(function(){try{return Promise.resolve(Promise.all([function(){try{return Promise.resolve(import("jimp").catch(function(){}))}catch(r){return Promise.reject(r)}}(),function(){try{return Promise.resolve(import("sharp").catch(function(){}))}catch(r){return Promise.reject(r)}}()])).then(function(r){var e=r[0],t=r[1];if(t)return{sharp:t};var n=(null==e?void 0:e.default)||e;if(n)return{jimp:n};throw new Error("No image processing library available, please install jimp or sharp as a dependency")})}catch(r){return Promise.reject(r)}}()).then(function(t){var n;function o(o){var i;if(n)return o;function s(r){if(i)return r;throw new Error("No image processing library available, please install jimp or sharp as a dependency")}var a=function(n){if("jimp"in t&&"function"==typeof(null==(n=t.jimp)?void 0:n.read))return Promise.resolve(t.jimp.read(r)).then(function(r){var n=r.getWidth()||0,o=r.getHeight()||0,s=0,a=0,u=n,c=o,f=n>o;return"COMPARED"===e&&(u=n-(s=f?21:27)-(f?22:30),c=o-(a=f?25:30)-(f?202:213)),"SINGLE"===e&&(u=n-(s=f?509:27)-(f?22:30),c=o-(a=f?25:544)-(f?202:213)),Promise.resolve(r.crop(s,a,u,c).getBufferAsync(t.jimp.MIME_PNG)).then(function(r){return i=1,r})})}();return a&&a.then?a.then(s):s(a)}var i=function(o){if("sharp"in t&&"function"==typeof(null==(o=t.sharp)?void 0:o.default)){var i=t.sharp.default(r);return Promise.resolve(i.metadata()).then(function(r){var t=r.width||0,o=r.height||0,s=0,a=0,u=t,c=o,f=t>o;return"COMPARED"===e&&(u=t-(s=f?21:27)-(f?22:30),c=o-(a=f?25:30)-(f?202:213)),"SINGLE"===e&&(u=t-(s=f?509:27)-(f?22:30),c=o-(a=f?25:544)-(f?202:213)),Promise.resolve(i.extract({left:s,top:a,width:u,height:c}).png().toBuffer()).then(function(r){return n=1,r})})}}();return i&&i.then?i.then(o):o(i)})},m=function(r,a){void 0===a&&(a=c);try{var m;return(a=Object.assign(c,a)).proxy&&(/^socks/.test(a.proxy)?(m=new t.SocksProxyAgent(a.proxy)).timeout=3e4:m=new n.HttpsProxyAgent(a.proxy)),Promise.resolve(h(r,m,a)).then(function(r){function t(r){var e=c.img_urls[1]||c.img_urls[0];return"COMPARED"===a.crop?Promise.resolve(h(e,m,a)).then(function(r){return Promise.resolve(l(r,"COMPARED"))}):"SINGLE"===a.crop?Promise.resolve(h(e,m,a)).then(function(r){return Promise.resolve(l(r,"SINGLE"))}):Promise.resolve(h(e,m,a)).then(function(r){return Promise.resolve(l(r))})}var n={busiId:"ai_painting_anime_img_entry",images:[r.toString("base64")],extra:JSON.stringify({face_rects:[],version:2,platform:"web"})},c={img_urls:[r.toString("base64")]},p=s(function(){return Promise.resolve(o(function(r){try{return Promise.resolve(e.request({method:"POST",url:"https://ai.tu.qq.com/trpc.shadow_cv.ai_processor_cgi.AIProcessorCgi/Process",data:n,headers:{"Content-Type":"application/json",Origin:"https://h5.tu.qq.com",Referer:"https://h5.tu.qq.com/","User-Agent":u,"x-sign-value":f(n),"x-sign-version":"v1"},timeout:3e4,httpsAgent:m,proxy:!1})).then(function(e){var t=null==e?void 0:e.data;if(!t)throw new Error("No data");if("VOLUMN_LIMIT"===t.msg)throw new Error("QQ rate limit caught");if((t.msg||"").includes("polaris limit"))throw new Error("QQ rate limit caught (polaris limit)");if("IMG_ILLEGAL"===t.msg||(t.msg||"").includes("image illegal"))r(new Error("Couldn't pass the censorship. Try another photo."));else if(1001!==t.code)if(-2100!==t.code){if(2119!==t.code&&-2111!==t.code){if(!t.extra)throw new Error("Got no data from QQ: "+JSON.stringify(t));return JSON.parse(t.extra)}r(new Error("Auth failed, the Chinese website has blocked this ip address."))}else r(new Error("Try another photo."));else r(new Error("Face not found. Try another photo."))})}catch(r){return Promise.reject(r)}},i({},a))).then(function(r){c=r})},function(r){throw new Error("Unable to upload the photo: "+("string"==typeof r?r:r.message))});return p&&p.then?p.then(t):t()})}catch(r){return Promise.reject(r)}};export{m as default};
