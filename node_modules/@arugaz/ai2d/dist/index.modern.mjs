import t from"fs";import r from"axios";import e from"socks-proxy-agent";import a from"https-proxy-agent";import o from"async-retry";function n(){return n=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var e=arguments[r];for(var a in e)Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a])}return t},n.apply(this,arguments)}const i=new RegExp(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&/=]*)/gi),s="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",c={retries:10,factor:1},p=t=>{function r(t,r,a,o,n,i,s){return e(r&a|~r&o,t,r,n,i,s)}function e(t,r,e,a,o,n){var s,c;return i((s=i(i(r,t),i(a,n)))<<(c=o)|s>>>32-c,e)}function a(t,r,a,o,n,i,s){return e(a^(r|~o),t,r,n,i,s)}function o(t,r,a,o,n,i,s){return e(r^a^o,t,r,n,i,s)}function n(t,r,a,o,n,i,s){return e(r&o|a&~o,t,r,n,i,s)}function i(t,r){var e=(65535&t)+(65535&r);return(t>>16)+(r>>16)+(e>>16)<<16|65535&e}return function(t){var r,e,a="0123456789abcdef",o="";for(e=0;e<t.length;e+=1)r=t.charCodeAt(e),o+=a.charAt(r>>>4&15)+a.charAt(15&r);return o}((s=`https://h5.tu.qq.com${((t="")=>{const r=encodeURIComponent(t).match(/%[89ABab]/g);return t.length+(r?r.length:0)})(JSON.stringify(t))}HQ31X02e`,function(t){return function(t){var r,e="",a=32*t.length;for(r=0;r<a;r+=8)e+=String.fromCharCode(t[r>>5]>>>r%32&255);return e}(function(t,e){var s,c,p,h,l;t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;var u=1732584193,f=-271733879,g=-1732584194,m=271733878;for(s=0;s<t.length;s+=16)c=u,p=f,h=g,l=m,u=r(u,f,g,m,t[s],7,-680876936),m=r(m,u,f,g,t[s+1],12,-389564586),g=r(g,m,u,f,t[s+2],17,606105819),f=r(f,g,m,u,t[s+3],22,-1044525330),u=r(u,f,g,m,t[s+4],7,-176418897),m=r(m,u,f,g,t[s+5],12,1200080426),g=r(g,m,u,f,t[s+6],17,-1473231341),f=r(f,g,m,u,t[s+7],22,-45705983),u=r(u,f,g,m,t[s+8],7,1770035416),m=r(m,u,f,g,t[s+9],12,-1958414417),g=r(g,m,u,f,t[s+10],17,-42063),f=r(f,g,m,u,t[s+11],22,-1990404162),u=r(u,f,g,m,t[s+12],7,1804603682),m=r(m,u,f,g,t[s+13],12,-40341101),g=r(g,m,u,f,t[s+14],17,-1502002290),u=n(u,f=r(f,g,m,u,t[s+15],22,1236535329),g,m,t[s+1],5,-165796510),m=n(m,u,f,g,t[s+6],9,-1069501632),g=n(g,m,u,f,t[s+11],14,643717713),f=n(f,g,m,u,t[s],20,-373897302),u=n(u,f,g,m,t[s+5],5,-701558691),m=n(m,u,f,g,t[s+10],9,38016083),g=n(g,m,u,f,t[s+15],14,-660478335),f=n(f,g,m,u,t[s+4],20,-405537848),u=n(u,f,g,m,t[s+9],5,568446438),m=n(m,u,f,g,t[s+14],9,-1019803690),g=n(g,m,u,f,t[s+3],14,-187363961),f=n(f,g,m,u,t[s+8],20,1163531501),u=n(u,f,g,m,t[s+13],5,-1444681467),m=n(m,u,f,g,t[s+2],9,-51403784),g=n(g,m,u,f,t[s+7],14,1735328473),u=o(u,f=n(f,g,m,u,t[s+12],20,-1926607734),g,m,t[s+5],4,-378558),m=o(m,u,f,g,t[s+8],11,-2022574463),g=o(g,m,u,f,t[s+11],16,1839030562),f=o(f,g,m,u,t[s+14],23,-35309556),u=o(u,f,g,m,t[s+1],4,-1530992060),m=o(m,u,f,g,t[s+4],11,1272893353),g=o(g,m,u,f,t[s+7],16,-155497632),f=o(f,g,m,u,t[s+10],23,-1094730640),u=o(u,f,g,m,t[s+13],4,681279174),m=o(m,u,f,g,t[s],11,-358537222),g=o(g,m,u,f,t[s+3],16,-722521979),f=o(f,g,m,u,t[s+6],23,76029189),u=o(u,f,g,m,t[s+9],4,-640364487),m=o(m,u,f,g,t[s+12],11,-421815835),g=o(g,m,u,f,t[s+15],16,530742520),u=a(u,f=o(f,g,m,u,t[s+2],23,-995338651),g,m,t[s],6,-198630844),m=a(m,u,f,g,t[s+7],10,1126891415),g=a(g,m,u,f,t[s+14],15,-1416354905),f=a(f,g,m,u,t[s+5],21,-57434055),u=a(u,f,g,m,t[s+12],6,1700485571),m=a(m,u,f,g,t[s+3],10,-1894986606),g=a(g,m,u,f,t[s+10],15,-1051523),f=a(f,g,m,u,t[s+1],21,-2054922799),u=a(u,f,g,m,t[s+8],6,1873313359),m=a(m,u,f,g,t[s+15],10,-30611744),g=a(g,m,u,f,t[s+6],15,-1560198380),f=a(f,g,m,u,t[s+13],21,1309151649),u=a(u,f,g,m,t[s+4],6,-145523070),m=a(m,u,f,g,t[s+11],10,-1120210379),g=a(g,m,u,f,t[s+2],15,718787259),f=a(f,g,m,u,t[s+9],21,-343485551),u=i(u,c),f=i(f,p),g=i(g,h),m=i(m,l);return[u,f,g,m]}(function(t){var r,e=[];for(e[(t.length>>2)-1]=void 0,r=0;r<e.length;r+=1)e[r]=0;var a=8*t.length;for(r=0;r<a;r+=8)e[r>>5]|=(255&t.charCodeAt(r/8))<<r%32;return e}(t),8*t.length))}(function(t){return decodeURIComponent(encodeURIComponent(t))}(s))));var s},h=async(e,a,c)=>{let p;if("string"==typeof e)if(e.match(i))try{p=await o(async()=>(await r.request({method:"GET",url:e,headers:{"User-Agent":s},responseType:"arraybuffer",httpsAgent:a,proxy:!1})).data,n({},c))}catch(t){throw new Error(`Unable to download media: ${t.toString()}`)}else try{await t.promises.access(e,t.promises.constants.F_OK),p=await t.promises.readFile(e)}catch(t){p=Buffer.from(e,"base64")}else p=e;return p},l=async(t,r)=>{var e,a;const o=await(async()=>{const[t,r]=await Promise.all([(async()=>await import("jimp").catch(()=>{}))(),(async()=>await import("sharp").catch(()=>{}))()]);if(r)return{sharp:r};const e=(null==t?void 0:t.default)||t;if(e)return{jimp:e};throw new Error("No image processing library available, please install jimp or sharp as a dependency")})();if("sharp"in o&&"function"==typeof(null==(e=o.sharp)?void 0:e.default)){const e=o.sharp.default(t),a=await e.metadata(),n=a.width||0,i=a.height||0;let s=0,c=0,p=n,h=i;const l=n>i;return"COMPARED"===r&&(s=l?21:27,c=l?25:30,p=n-s-(l?22:30),h=i-c-(l?202:213)),"SINGLE"===r&&(s=l?509:27,c=l?25:544,p=n-s-(l?22:30),h=i-c-(l?202:213)),await e.extract({left:s,top:c,width:p,height:h}).png().toBuffer()}if("jimp"in o&&"function"==typeof(null==(a=o.jimp)?void 0:a.read)){const e=await o.jimp.read(t),a=e.getWidth()||0,n=e.getHeight()||0;let i=0,s=0,c=a,p=n;const h=a>n;return"COMPARED"===r&&(i=h?21:27,s=h?25:30,c=a-i-(h?22:30),p=n-s-(h?202:213)),"SINGLE"===r&&(i=h?509:27,s=h?25:544,c=a-i-(h?22:30),p=n-s-(h?202:213)),await e.crop(i,s,c,p).getBufferAsync(o.jimp.MIME_PNG)}throw new Error("No image processing library available, please install jimp or sharp as a dependency")},u=async(t,i=c)=>{let u;(i=Object.assign(c,i)).proxy&&(/^socks/.test(i.proxy)?(u=new e.SocksProxyAgent(i.proxy),u.timeout=3e4):u=new a.HttpsProxyAgent(i.proxy));const f=await h(t,u,i),g={busiId:"ai_painting_anime_img_entry",images:[f.toString("base64")],extra:JSON.stringify({face_rects:[],version:2,platform:"web"})};let m={img_urls:[f.toString("base64")]};try{m=await o(async t=>{const e=await r.request({method:"POST",url:"https://ai.tu.qq.com/trpc.shadow_cv.ai_processor_cgi.AIProcessorCgi/Process",data:g,headers:{"Content-Type":"application/json",Origin:"https://h5.tu.qq.com",Referer:"https://h5.tu.qq.com/","User-Agent":s,"x-sign-value":p(g),"x-sign-version":"v1"},timeout:3e4,httpsAgent:u,proxy:!1}),a=null==e?void 0:e.data;if(!a)throw new Error("No data");if("VOLUMN_LIMIT"===a.msg)throw new Error("QQ rate limit caught");if((a.msg||"").includes("polaris limit"))throw new Error("QQ rate limit caught (polaris limit)");if("IMG_ILLEGAL"===a.msg||(a.msg||"").includes("image illegal"))t(new Error("Couldn't pass the censorship. Try another photo."));else if(1001!==a.code)if(-2100!==a.code){if(2119!==a.code&&-2111!==a.code){if(!a.extra)throw new Error("Got no data from QQ: "+JSON.stringify(a));return JSON.parse(a.extra)}t(new Error("Auth failed, the Chinese website has blocked this ip address."))}else t(new Error("Try another photo."));else t(new Error("Face not found. Try another photo."))},n({},i))}catch(t){throw new Error(`Unable to upload the photo: ${"string"==typeof t?t:t.message}`)}const d=m.img_urls[1]||m.img_urls[0];return"COMPARED"===i.crop?await l(await h(d,u,i),"COMPARED"):"SINGLE"===i.crop?await l(await h(d,u,i),"SINGLE"):await l(await h(d,u,i))};export{u as default};
