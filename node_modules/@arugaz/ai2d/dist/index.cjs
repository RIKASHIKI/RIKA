var e=require("fs"),r=require("axios"),t=require("socks-proxy-agent"),n=require("https-proxy-agent"),o=require("async-retry");function i(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}function u(e){if(e&&e.__esModule)return e;var r=Object.create(null);return e&&Object.keys(e).forEach(function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}}),r.default=e,r}var a=/*#__PURE__*/i(e),s=/*#__PURE__*/i(r),c=/*#__PURE__*/i(t),f=/*#__PURE__*/i(n),h=/*#__PURE__*/i(o);function l(){return l=Object.assign?Object.assign.bind():function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])}return e},l.apply(this,arguments)}function p(e,r){try{var t=e()}catch(e){return r(e)}return t&&t.then?t.then(void 0,r):t}var m=new RegExp(/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()@:%_+.~#?&/=]*)/gi),d="Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Safari/537.36",v={retries:10,factor:1},g=function(e){function r(e,r,n,o,i,u,a){return t(r&n|~r&o,e,r,i,u,a)}function t(e,r,t,n,o,i){var a,s;return u((a=u(u(r,e),u(n,i)))<<(s=o)|a>>>32-s,t)}function n(e,r,n,o,i,u,a){return t(n^(r|~o),e,r,i,u,a)}function o(e,r,n,o,i,u,a){return t(r^n^o,e,r,i,u,a)}function i(e,r,n,o,i,u,a){return t(r&o|n&~o,e,r,i,u,a)}function u(e,r){var t=(65535&e)+(65535&r);return(e>>16)+(r>>16)+(t>>16)<<16|65535&t}return function(e){var r,t,n="0123456789abcdef",o="";for(t=0;t<e.length;t+=1)r=e.charCodeAt(t),o+=n.charAt(r>>>4&15)+n.charAt(15&r);return o}((a="https://h5.tu.qq.com"+function(e){void 0===e&&(e="");var r=encodeURIComponent(e).match(/%[89ABab]/g);return e.length+(r?r.length:0)}(JSON.stringify(e))+"HQ31X02e",function(e){return function(e){var r,t="",n=32*e.length;for(r=0;r<n;r+=8)t+=String.fromCharCode(e[r>>5]>>>r%32&255);return t}(function(e,t){var a,s,c,f,h;e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;var l=1732584193,p=-271733879,m=-1732584194,d=271733878;for(a=0;a<e.length;a+=16)s=l,c=p,f=m,h=d,l=r(l,p,m,d,e[a],7,-680876936),d=r(d,l,p,m,e[a+1],12,-389564586),m=r(m,d,l,p,e[a+2],17,606105819),p=r(p,m,d,l,e[a+3],22,-1044525330),l=r(l,p,m,d,e[a+4],7,-176418897),d=r(d,l,p,m,e[a+5],12,1200080426),m=r(m,d,l,p,e[a+6],17,-1473231341),p=r(p,m,d,l,e[a+7],22,-45705983),l=r(l,p,m,d,e[a+8],7,1770035416),d=r(d,l,p,m,e[a+9],12,-1958414417),m=r(m,d,l,p,e[a+10],17,-42063),p=r(p,m,d,l,e[a+11],22,-1990404162),l=r(l,p,m,d,e[a+12],7,1804603682),d=r(d,l,p,m,e[a+13],12,-40341101),m=r(m,d,l,p,e[a+14],17,-1502002290),l=i(l,p=r(p,m,d,l,e[a+15],22,1236535329),m,d,e[a+1],5,-165796510),d=i(d,l,p,m,e[a+6],9,-1069501632),m=i(m,d,l,p,e[a+11],14,643717713),p=i(p,m,d,l,e[a],20,-373897302),l=i(l,p,m,d,e[a+5],5,-701558691),d=i(d,l,p,m,e[a+10],9,38016083),m=i(m,d,l,p,e[a+15],14,-660478335),p=i(p,m,d,l,e[a+4],20,-405537848),l=i(l,p,m,d,e[a+9],5,568446438),d=i(d,l,p,m,e[a+14],9,-1019803690),m=i(m,d,l,p,e[a+3],14,-187363961),p=i(p,m,d,l,e[a+8],20,1163531501),l=i(l,p,m,d,e[a+13],5,-1444681467),d=i(d,l,p,m,e[a+2],9,-51403784),m=i(m,d,l,p,e[a+7],14,1735328473),l=o(l,p=i(p,m,d,l,e[a+12],20,-1926607734),m,d,e[a+5],4,-378558),d=o(d,l,p,m,e[a+8],11,-2022574463),m=o(m,d,l,p,e[a+11],16,1839030562),p=o(p,m,d,l,e[a+14],23,-35309556),l=o(l,p,m,d,e[a+1],4,-1530992060),d=o(d,l,p,m,e[a+4],11,1272893353),m=o(m,d,l,p,e[a+7],16,-155497632),p=o(p,m,d,l,e[a+10],23,-1094730640),l=o(l,p,m,d,e[a+13],4,681279174),d=o(d,l,p,m,e[a],11,-358537222),m=o(m,d,l,p,e[a+3],16,-722521979),p=o(p,m,d,l,e[a+6],23,76029189),l=o(l,p,m,d,e[a+9],4,-640364487),d=o(d,l,p,m,e[a+12],11,-421815835),m=o(m,d,l,p,e[a+15],16,530742520),l=n(l,p=o(p,m,d,l,e[a+2],23,-995338651),m,d,e[a],6,-198630844),d=n(d,l,p,m,e[a+7],10,1126891415),m=n(m,d,l,p,e[a+14],15,-1416354905),p=n(p,m,d,l,e[a+5],21,-57434055),l=n(l,p,m,d,e[a+12],6,1700485571),d=n(d,l,p,m,e[a+3],10,-1894986606),m=n(m,d,l,p,e[a+10],15,-1051523),p=n(p,m,d,l,e[a+1],21,-2054922799),l=n(l,p,m,d,e[a+8],6,1873313359),d=n(d,l,p,m,e[a+15],10,-30611744),m=n(m,d,l,p,e[a+6],15,-1560198380),p=n(p,m,d,l,e[a+13],21,1309151649),l=n(l,p,m,d,e[a+4],6,-145523070),d=n(d,l,p,m,e[a+11],10,-1120210379),m=n(m,d,l,p,e[a+2],15,718787259),p=n(p,m,d,l,e[a+9],21,-343485551),l=u(l,s),p=u(p,c),m=u(m,f),d=u(d,h);return[l,p,m,d]}(function(e){var r,t=[];for(t[(e.length>>2)-1]=void 0,r=0;r<t.length;r+=1)t[r]=0;var n=8*e.length;for(r=0;r<n;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<r%32;return t}(e),8*e.length))}(function(e){return decodeURIComponent(encodeURIComponent(e))}(a))));var a},y=function(e,r,t){try{var n,o=function(){if("string"==typeof e)return function(){if(e.match(m))return p(function(){return Promise.resolve(h.default(function(){try{return Promise.resolve(s.default.request({method:"GET",url:e,headers:{"User-Agent":d},responseType:"arraybuffer",httpsAgent:r,proxy:!1})).then(function(e){return e.data})}catch(e){return Promise.reject(e)}},l({},t))).then(function(e){n=e})},function(e){throw new Error("Unable to download media: "+e.toString())});var o=p(function(){return Promise.resolve(a.default.promises.access(e,a.default.promises.constants.F_OK)).then(function(){return Promise.resolve(a.default.promises.readFile(e)).then(function(e){n=e})})},function(){n=Buffer.from(e,"base64")});return o&&o.then?o.then(function(){}):void 0}();n=e}();return Promise.resolve(o&&o.then?o.then(function(e){return n}):n)}catch(e){return Promise.reject(e)}},P=function(e,r){return Promise.resolve(function(){try{return Promise.resolve(Promise.all([function(){try{return Promise.resolve(Promise.resolve().then(function(){/*#__PURE__*/return u(require("jimp"))}).catch(function(){}))}catch(e){return Promise.reject(e)}}(),function(){try{return Promise.resolve(Promise.resolve().then(function(){/*#__PURE__*/return u(require("sharp"))}).catch(function(){}))}catch(e){return Promise.reject(e)}}()])).then(function(e){var r=e[0],t=e[1];if(t)return{sharp:t};var n=(null==r?void 0:r.default)||r;if(n)return{jimp:n};throw new Error("No image processing library available, please install jimp or sharp as a dependency")})}catch(e){return Promise.reject(e)}}()).then(function(t){var n;function o(o){var i;if(n)return o;function u(e){if(i)return e;throw new Error("No image processing library available, please install jimp or sharp as a dependency")}var a=function(n){if("jimp"in t&&"function"==typeof(null==(n=t.jimp)?void 0:n.read))return Promise.resolve(t.jimp.read(e)).then(function(e){var n=e.getWidth()||0,o=e.getHeight()||0,u=0,a=0,s=n,c=o,f=n>o;return"COMPARED"===r&&(s=n-(u=f?21:27)-(f?22:30),c=o-(a=f?25:30)-(f?202:213)),"SINGLE"===r&&(s=n-(u=f?509:27)-(f?22:30),c=o-(a=f?25:544)-(f?202:213)),Promise.resolve(e.crop(u,a,s,c).getBufferAsync(t.jimp.MIME_PNG)).then(function(e){return i=1,e})})}();return a&&a.then?a.then(u):u(a)}var i=function(o){if("sharp"in t&&"function"==typeof(null==(o=t.sharp)?void 0:o.default)){var i=t.sharp.default(e);return Promise.resolve(i.metadata()).then(function(e){var t=e.width||0,o=e.height||0,u=0,a=0,s=t,c=o,f=t>o;return"COMPARED"===r&&(s=t-(u=f?21:27)-(f?22:30),c=o-(a=f?25:30)-(f?202:213)),"SINGLE"===r&&(s=t-(u=f?509:27)-(f?22:30),c=o-(a=f?25:544)-(f?202:213)),Promise.resolve(i.extract({left:u,top:a,width:s,height:c}).png().toBuffer()).then(function(e){return n=1,e})})}}();return i&&i.then?i.then(o):o(i)})};module.exports=function(e,r){void 0===r&&(r=v);try{var t;return(r=Object.assign(v,r)).proxy&&(/^socks/.test(r.proxy)?(t=new c.default.SocksProxyAgent(r.proxy)).timeout=3e4:t=new f.default.HttpsProxyAgent(r.proxy)),Promise.resolve(y(e,t,r)).then(function(e){function n(e){var n=i.img_urls[1]||i.img_urls[0];return"COMPARED"===r.crop?Promise.resolve(y(n,t,r)).then(function(e){return Promise.resolve(P(e,"COMPARED"))}):"SINGLE"===r.crop?Promise.resolve(y(n,t,r)).then(function(e){return Promise.resolve(P(e,"SINGLE"))}):Promise.resolve(y(n,t,r)).then(function(e){return Promise.resolve(P(e))})}var o={busiId:"ai_painting_anime_img_entry",images:[e.toString("base64")],extra:JSON.stringify({face_rects:[],version:2,platform:"web"})},i={img_urls:[e.toString("base64")]},u=p(function(){return Promise.resolve(h.default(function(e){try{return Promise.resolve(s.default.request({method:"POST",url:"https://ai.tu.qq.com/trpc.shadow_cv.ai_processor_cgi.AIProcessorCgi/Process",data:o,headers:{"Content-Type":"application/json",Origin:"https://h5.tu.qq.com",Referer:"https://h5.tu.qq.com/","User-Agent":d,"x-sign-value":g(o),"x-sign-version":"v1"},timeout:3e4,httpsAgent:t,proxy:!1})).then(function(r){var t=null==r?void 0:r.data;if(!t)throw new Error("No data");if("VOLUMN_LIMIT"===t.msg)throw new Error("QQ rate limit caught");if((t.msg||"").includes("polaris limit"))throw new Error("QQ rate limit caught (polaris limit)");if("IMG_ILLEGAL"===t.msg||(t.msg||"").includes("image illegal"))e(new Error("Couldn't pass the censorship. Try another photo."));else if(1001!==t.code)if(-2100!==t.code){if(2119!==t.code&&-2111!==t.code){if(!t.extra)throw new Error("Got no data from QQ: "+JSON.stringify(t));return JSON.parse(t.extra)}e(new Error("Auth failed, the Chinese website has blocked this ip address."))}else e(new Error("Try another photo."));else e(new Error("Face not found. Try another photo."))})}catch(e){return Promise.reject(e)}},l({},r))).then(function(e){i=e})},function(e){throw new Error("Unable to upload the photo: "+("string"==typeof e?e:e.message))});return u&&u.then?u.then(n):n()})}catch(e){return Promise.reject(e)}};
